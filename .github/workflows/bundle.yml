# Generated by internal/ci/ci_tool.cue; do not edit

name: Deploy Bundle
on:
  repository_dispatch:
    types:
    - bundle
env:
  IMAGE_REGISTRY: quay.io/rh-marketplace
jobs:
  deploy:
    name: Deploy Bundle
    runs-on: ubuntu-20.04
    defaults:
      run:
        shell: bash
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        ref: ${{github.event.client_payload.sha}}
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.15.6
    - name: Cache Go modules
      uses: actions/cache@v2
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: ${{ runner.os }}-1.15.6-go-
    - name: Install operatorsdk
      run: |-
        export ARCH=$(case $(arch) in x86_64) echo -n amd64 ;; aarch64) echo -n arm64 ;; *) echo -n $(arch) ;; esac)
        export OS=$(uname | awk '{print tolower($0)}')
        export OPERATOR_SDK_DL_URL=https://github.com/operator-framework/operator-sdk/releases/latest/download
        curl -LO ${OPERATOR_SDK_DL_URL}/operator-sdk_${OS}_${ARCH}
        curl -LO ${OPERATOR_SDK_DL_URL}/checksums.txt
        curl -LO ${OPERATOR_SDK_DL_URL}/checksums.txt.asc
        grep operator-sdk_${OS}_${ARCH} checksums.txt | sha256sum -c -
        chmod +x operator-sdk_${OS}_${ARCH} && sudo mv operator-sdk_${OS}_${ARCH} /usr/local/bin/operator-sdk
    - name: Install YQ
      run: snap install yq
    - id: create-action
      uses: actions/github-script@v3
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |-
          var obj = {
          owner: context.repo.owner,
          repo: context.repo.repo,
          name: 'Operator: Deploy Bundle',
          head_sha: '${{github.event.client_payload.sha}}',
          status: 'in_progress'
          }
          return await github.request('POST /repos/{owner}/{repo}/check-runs', obj)
    - id: bundle
      name: Build bundle
      run: |-
        VERSION=$(make operator/current-version)-${GITHUB_SHA}
        TAG=$(make operator/current-version)-${GITHUB_SHA}
        cd v2
        make bundle bundle-stable bundle-deploy bundle-dev-index
    - if: ${{ always() }}
      uses: actions/github-script@v3
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |-
          var obj = {
          owner: context.repo.owner,
          repo: context.repo.repo,
          name: 'Operator: Deploy Bundle',
          head_sha: '${{github.event.client_payload.sha}}',
          status: 'completed',
          conclusion: '${{steps.bundle.conclusion}}',
          check_run_id: '${{steps.create-action.outputs.id}}'
          }
          return await github.request('PATCH /repos/{owner}/{repo}/check-runs/{check_run_id}', obj)
  publish:
    name: Publish Images
    needs:
    - deploy
    runs-on: ubuntu-20.04
    defaults:
      run:
        shell: bash
    if: (startsWith(github.ref,'refs/heads/release/') || startsWith(github.ref,'refs/heads/hotfix/'))
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        ref: ${{github.event.client_payload.sha}}
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.15.6
    - name: Cache Go modules
      uses: actions/cache@v2
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: ${{ runner.os }}-1.15.6-go-
    - name: Install operatorsdk
      run: |-
        export ARCH=$(case $(arch) in x86_64) echo -n amd64 ;; aarch64) echo -n arm64 ;; *) echo -n $(arch) ;; esac)
        export OS=$(uname | awk '{print tolower($0)}')
        export OPERATOR_SDK_DL_URL=https://github.com/operator-framework/operator-sdk/releases/latest/download
        curl -LO ${OPERATOR_SDK_DL_URL}/operator-sdk_${OS}_${ARCH}
        curl -LO ${OPERATOR_SDK_DL_URL}/checksums.txt
        curl -LO ${OPERATOR_SDK_DL_URL}/checksums.txt.asc
        grep operator-sdk_${OS}_${ARCH} checksums.txt | sha256sum -c -
        chmod +x operator-sdk_${OS}_${ARCH} && sudo mv operator-sdk_${OS}_${ARCH} /usr/local/bin/operator-sdk
    - name: Mirror images
      run: |-
        skopeo copy docker://quay.io/rh-marketplace/redhat-marketplace-operator:$VERSION docker://scan.connect.redhat.com/ospid-c93f69b6-cb04-437b-89d6-e5220ce643cd/redhat-marketplace-operator:$VERSION --dest-creds ${{secrets.matrix['pcUser']}}:${{secrets.matrix['(v.pword)']}}
        skopeo copy docker://quay.io/rh-marketplace/redhat-marketplace-metric-state:$VERSION docker://scan.connect.redhat.com/ospid-9b9b0dbe-7adc-448e-9385-a556714a09c4/redhat-marketplace-metric-state:$VERSION --dest-creds ${{secrets.matrix['pcUser']}}:${{secrets.matrix['(v.pword)']}}
        skopeo copy docker://quay.io/rh-marketplace/redhat-marketplace-reporter:$VERSION docker://scan.connect.redhat.com/ospid-faa0f295-e195-4bcc-a3fc-a4b97ada317e/redhat-marketplace-reporter:$VERSION --dest-creds ${{secrets.matrix['pcUser']}}:${{secrets.matrix['(v.pword)']}}
        skopeo copy docker://quay.io/rh-marketplace/redhat-marketplace-authchecker:$VERSION docker://scan.connect.redhat.com/ospid-ffed416e-c18d-4b88-8660-f586a4792785/redhat-marketplace-authchecker:$VERSION --dest-creds ${{secrets.matrix['pcUser']}}:${{secrets.matrix['(v.pword)']}}

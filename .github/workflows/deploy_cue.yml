# Generated by internal/ci/ci_tool.cue; do not edit

name: Test & Deploy Image
on:
  push:
    branches:
    - master
    - release/**
    - hotfix/**
    - develop
    - feature/**
    - bugfix/**
env:
  pushImage: true
  IMAGE_REGISTRY: quay.io/rh-marketplace
jobs:
  preset:
    name: Set Vars
    runs-on: ubuntu-20.04
    defaults:
      run:
        shell: bash
    steps:
    - name: Cancel Previous Run
      uses: styfle/cancel-workflow-action@0.4.1
      with:
        access_token: ${{ github.token }}
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.15.6
    - name: Cache Go modules
      uses: actions/cache@v@
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: ${{ runner.os }}-1.15.6-go-
    - id: tag
      name: Get if gittag is pushed
      run: |-
        VERSION=$(make current-version)
        RESULT=$(git tag --list | grep -E "$VERSION")
        IS_TAGGED=false
        if [ "$RESULT" != "" ] ; then
          IS_TAGGED=true
    - if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
      name: Setting tags for dev
      run: |-
        echo "TAGPREFIX=dev-" >> $GITHUB_ENV
        if [ "" != "" ]; then
          echo "QUAY_EXPIRATION=" >> $GITHUB_ENV
        fi
    - if: github.event_name == 'push' && startsWith(github.ref,'refs/heads/bugfix/')
      name: Setting tags for fix
      run: |-
        echo "TAGPREFIX=bugfix-${NAME}-" >> $GITHUB_ENV
        if [ "1w" != "" ]; then
          echo "QUAY_EXPIRATION=1w" >> $GITHUB_ENV
        fi
    - if: github.event_name == 'push' && startsWith(github.ref,'refs/heads/feature/')
      name: Setting tags for feature
      run: |-
        echo "TAGPREFIX=feat-${NAME}-" >> $GITHUB_ENV
        if [ "1w" != "" ]; then
          echo "QUAY_EXPIRATION=1w" >> $GITHUB_ENV
        fi
  test-unit:
    name: Test
    runs-on: ubuntu-20.04
    needs:
    - build
    env:
      OPERATOR_IMAGE: ${{ env.IMAGE_REGISTRY }}/redhat-marketplace-operator:${{ needs.build.outputs.dockertag
        }}
      OPERATOR_IMAGE_TAG: ${{ needs.build.outputs.dockertag }}
      TAG: quay.io/rh-marketplace/redhat-marketplace-operator:${{ needs.build.outputs.dockertag}}
    defaults:
      run:
        shell: bash
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
      name: Setting tags for dev
      run: |-
        echo "TAGPREFIX=dev-" >> $GITHUB_ENV
        if [ "" != "" ]; then
          echo "QUAY_EXPIRATION=" >> $GITHUB_ENV
        fi

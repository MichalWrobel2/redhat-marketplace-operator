# Generated by internal/ci/ci_tool.cue; do not edit

version: ~> 1.0
dist: focal
if: branch = master || branch = develop
language: go
services:
- docker
before_script:
- go get github.com/onsi/ginkgo/ginkgo
- docker pull docker.io/docker/dockerfile:experimental
- docker pull docker.io/docker/dockerfile-copy:v0.1.9
- export VERSION=`cd v2/tools && go run ./version/main.go`-${TRAVIS_COMMIT}
- docker login -u="${ROBOT_USER_NAME}" -p="${ROBOT_PASS_PHRASE}" quay.io
go: 1.15.6
env:
  global:
  - IMAGE_REGISTRY=quay.io/rh-marketplace DOCKER_CLI_EXPERIMENTAL=enabled DOCKER_BUILDKIT=1
    QUAY_EXPIRATION=never BUILDX=false
jobs:
  include:
  - stage: push
    arch: amd64
    env: ARCH=amd64
  - stage: push
    arch: ppc64le
    env: ARCH=ppc64le
  - stage: push
    arch: s390x
    env: ARCH=s390x
  - stage: manifest
    script: |-
      echo "making manifest for $VERSION"
      make docker-manifest
  - stage: retag
    if: type = pull_request && head_branch =~ /^(release|hotfix).*$/
    script: |-
      docker tag quay.io/rh-marketplace/redhat-marketplace-operator:$VERSION scan.connect.redhat.com/ospid-c93f69b6-cb04-437b-89d6-e5220ce643cd/redhat-marketplace-operator:$VERSION
      docker push scan.connect.redhat.com/ospid-c93f69b6-cb04-437b-89d6-e5220ce643cd/redhat-marketplace-operator:$VERSION
      docker tag quay.io/rh-marketplace/redhat-marketplace-reporter:$VERSION scan.connect.redhat.com/ospid-faa0f295-e195-4bcc-a3fc-a4b97ada317e/redhat-marketplace-reporter:$VERSION
      docker push scan.connect.redhat.com/ospid-faa0f295-e195-4bcc-a3fc-a4b97ada317e/redhat-marketplace-reporter:$VERSION
      docker tag quay.io/rh-marketplace/redhat-marketplace-metric-state:$VERSION scan.connect.redhat.com/ospid-9b9b0dbe-7adc-448e-9385-a556714a09c4/redhat-marketplace-metric-state:$VERSION
      docker push scan.connect.redhat.com/ospid-9b9b0dbe-7adc-448e-9385-a556714a09c4/redhat-marketplace-metric-state:$VERSION
      docker tag quay.io/rh-marketplace/redhat-marketplace-authchecker:$VERSION scan.connect.redhat.com/ospid-ffed416e-c18d-4b88-8660-f586a4792785/redhat-marketplace-authchecker:$VERSION
      docker push scan.connect.redhat.com/ospid-ffed416e-c18d-4b88-8660-f586a4792785/redhat-marketplace-authchecker:$VERSION
script:
- docker --version
- export VERSION=${VERSION}-${ARCH}
- echo  ${VERSION}
- echo "Login to Quay.io docker account..."
- |-
  echo "run tests if not s390x because kubebuilder has no binaries for it"
  if [ "$(go env GOARCH)" = "amd64" ]; then
  os=$(go env GOOS)
  arch=$(go env GOARCH)

  # download kubebuilder and extract it to tmp
  curl -L https://go.kubebuilder.io/dl/2.3.1/${os}/${arch} | tar -xz -C /tmp/

  # move to a long-term location and put it on your path
  # (you'll need to set the KUBEBUILDER_ASSETS env var if you put it somewhere else)
  sudo mv /tmp/kubebuilder_2.3.1_${os}_${arch} /usr/local/kubebuilder
  echo "/usr/local/kubebuilder/bin" >> $GITHUB_PATH

  export PATH=$PATH:/usr/local/kubebuilder/bin
  make operator/test-ci-unit
  fi
- echo "Building the Red Hat Marketplace operator images for ${ARCH}..."
- make docker-build
- make docker-push
- echo "Docker Image push to quay.io is done !"
